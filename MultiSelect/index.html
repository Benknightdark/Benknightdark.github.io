<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MultiSelect</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .dropdown-menu {
        display: none;
        max-height: 200px;
        overflow-y: auto;
      }
      .select-container {
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }
      .select-container input {
        border: none;
        outline: none;
        flex-grow: 1;
        min-width: 120px;
      }
      .badge {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="dropdown">
        <div class="select-container">
          <input
            type="text"
            id="searchInput"
            autocomplete="off"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            placeholder="開始搜尋..."
          />
        </div>
        <ul class="dropdown-menu w-100" aria-labelledby="searchInput"></ul>
      </div>
    </div>

    <script>
        class Select2Dropdown {
          constructor(options, selector) {
              this.options = options;
              this.container = $(selector);
              this.input = this.container.find("input");
              this.menu = this.container.find(".dropdown-menu");
              this.selectedIndex = -1;
              this.initEvents();
          }

          initEvents() {
              this.input.on("keydown", (e) => {
                  // 處理 Backspace 鍵在輸入框為空的情況
                  if (e.key === "Backspace" && this.input.val() === "") {
                      this.removeLastBadge();
                      e.preventDefault(); // 防止更多的鍵盤事件處理
                  }
                  if (["ArrowDown", "ArrowUp", "Enter", "Escape"].includes(e.key)) {
                      this.handleKeyboardNavigation(e.key);
                  } else {
                      setTimeout(() => {
                          const searchText = this.input.val();
                          this.populateMenu(searchText);
                          if (searchText.length > 0) {
                              this.menu.show();
                          } else {
                              this.menu.hide();
                          }
                      });
                  }
              });

              this.container.on("click", ".dropdown-item", (e) => {
                  e.preventDefault();
                  this.selectItem($(e.target));
              });

              this.container.on("click", ".badge .close", (e) => {
                  $(e.target).closest('.badge').remove();
              });

              $(document).on("click", (e) => {
                  if (!this.container.is(e.target) && this.container.has(e.target).length === 0) {
                      this.menu.hide();
                  }
              });

              $(document).on("keydown", (e) => {
                  if (e.key === "Escape") {
                      this.menu.hide();
                  }
              });
          }

          populateMenu(searchText) {
              this.menu.empty();
              const filteredOptions = this.options.filter((option) =>
                  option.toLowerCase().includes(searchText.toLowerCase())
              );
              filteredOptions.forEach((option, index) => {
                  this.menu.append(
                      `<li><a class="dropdown-item" href="#" data-index="${index}">${option}</a></li>`
                  );
              });
              if (filteredOptions.length === 1) {
                  this.selectedIndex = 0;
                  this.updateSelectedItem();
              } else {
                  this.selectedIndex = -1;
              }
              // 不顯示空的 menu
              if (searchText.trim().length === 0 || filteredOptions.length === 0) {
                  this.menu.hide();
              }
          }

          handleKeyboardNavigation(key) {
              const items = this.menu.find(".dropdown-item");
              if (key === "ArrowDown") {
                  this.selectedIndex = (this.selectedIndex + 1) % items.length;
                  this.updateSelectedItem();
              } else if (key === "ArrowUp") {
                  this.selectedIndex = (this.selectedIndex - 1 + items.length) % items.length;
                  this.updateSelectedItem();
              } else if (key === "Enter" && this.selectedIndex !== -1) {
                  this.selectItem(items.eq(this.selectedIndex));
              } else if (key === "Escape") {
                  this.menu.hide();
              }
          }

          updateSelectedItem() {
              this.menu.find(".dropdown-item.active").removeClass("active");
              this.menu.find(".dropdown-item").eq(this.selectedIndex).addClass("active");
          }

          selectItem(item) {
              const value = item.text();
              this.addBadge(value);
              this.input.val("").focus();
              this.populateMenu("");
              this.menu.hide();
          }

          addBadge(value) {
              const badge = $(
                  `<span class="badge bg-primary">${value}<span class="ms-2 close">&times;</span></span>`
              );
              badge.insertBefore(this.input);
          }

          removeLastBadge() {
              const lastBadge = this.container.find('.badge').last();
              if (lastBadge.length) {
                  lastBadge.remove();
              }
          }
      }

      $(document).ready(() => {
          const options = ["選項 1", "選項 2", "選項 3", "選項 4"];
          const dropdown = new Select2Dropdown(options, ".dropdown");
      });
    </script>
  </body>
</html>
